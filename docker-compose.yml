services:
  bot:
    build:
      context: ./bot
    environment:
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      ELEVENLABS_API_KEY: ${ELEVENLABS_API_KEY}
      ELEVENLABS_MODEL_ID: ${ELEVENLABS_MODEL_ID:-scribe_v2}
      ELEVENLABS_TIMESTAMPS_GRANULARITY: ${ELEVENLABS_TIMESTAMPS_GRANULARITY:-none}
      ELEVENLABS_TAG_AUDIO_EVENTS: ${ELEVENLABS_TAG_AUDIO_EVENTS:-false}
      ELEVENLABS_DIARIZE: ${ELEVENLABS_DIARIZE:-false}
      ELEVENLABS_NUM_SPEAKERS: ${ELEVENLABS_NUM_SPEAKERS:-}
      LANGUAGE_HINT: ${LANGUAGE_HINT:-}
      MAX_FILE_MB: ${MAX_FILE_MB:-20}
      CONCURRENCY: ${CONCURRENCY:-1}
      MAX_QUEUE: ${MAX_QUEUE:-20}
      ELEVENLABS_TIMEOUT_MS: ${ELEVENLABS_TIMEOUT_MS:-120000}
      ELEVENLABS_RETRIES: ${ELEVENLABS_RETRIES:-2}
      HEALTH_PORT: ${HEALTH_PORT:-3000}
      STATS_PATH: ${STATS_PATH:-/data/stats.json}
    volumes:
      - bot-stats:/data
    restart: unless-stopped
    mem_limit: 512m
    cpus: "1.0"
    healthcheck:
      test:
        [
          "CMD",
          "bun",
          "-e",
          "fetch('http://127.0.0.1:' + (process.env.HEALTH_PORT ?? '3000') + '/health').then(r => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))",
        ]
      interval: 30s
      timeout: 5s
      retries: 3

volumes:
  bot-stats:
