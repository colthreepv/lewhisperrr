services:
  asr:
    build:
      context: ./asr
    environment:
      - WHISPER_MODEL=${WHISPER_MODEL:-small}
      - DEVICE=${DEVICE:-cpu}
      - COMPUTE_TYPE=${COMPUTE_TYPE:-int8}
      - WEB_CONCURRENCY=${WEB_CONCURRENCY:-2}
      - MAX_TRANSCRIBE_WORKERS=${MAX_TRANSCRIBE_WORKERS:-1}
    volumes:
      - whisper-cache:/root/.cache
    ports:
      - "8000:8000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    mem_limit: 6g
    cpus: "2.0"

  bot:
    build:
      context: ./bot
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - ASR_URL=${ASR_URL:-http://asr:8000}
      - WHISPER_MODEL=${WHISPER_MODEL:-small}
      - LANGUAGE_HINT=${LANGUAGE_HINT:-}
      - MAX_AUDIO_SECONDS=${MAX_AUDIO_SECONDS:-180}
      - MAX_FILE_MB=${MAX_FILE_MB:-20}
      - CONCURRENCY=${CONCURRENCY:-1}
      - MAX_QUEUE=${MAX_QUEUE:-20}
      - ASR_TIMEOUT_MS=${ASR_TIMEOUT_MS:-120000}
      - ASR_RETRIES=${ASR_RETRIES:-2}
      - ASR_STARTUP_RETRIES=${ASR_STARTUP_RETRIES:-20}
      - ASR_STARTUP_DELAY_MS=${ASR_STARTUP_DELAY_MS:-1500}
      - STATS_PATH=${STATS_PATH:-/data/stats.json}
    volumes:
      - bot-stats:/data
    depends_on:
      asr:
        condition: service_healthy
    restart: unless-stopped
    mem_limit: 512m
    cpus: "1.0"

volumes:
  whisper-cache:
  bot-stats:
